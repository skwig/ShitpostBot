# ============================================
# SCENARIO 2: Low Similarity - Unrelated Images (No Repost)
# ============================================
# This scenario tests that unrelated images are NOT detected as reposts
# and result in 0 emoji reactions.

### 1a. Post original french_snails
< {%
    client.global.clearAll()
%}
POST {{host}}/test/image-message
Content-Type: application/json

{
  "imageUrl": "https://raw.githubusercontent.com/skwig/ShitpostBot/refs/heads/master/test/sample-data/french_snails.webp"
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.test("Response has tracked=true", function () {
        client.assert(response.body.tracked === true, "tracked should be true");
    });

    client.global.set("firstImageMessageId", response.body.messageId);
%}

### 1b. Post original family_guy_bill_gates
POST {{host}}/test/image-message
Content-Type: application/json

{
  "imageUrl": "https://raw.githubusercontent.com/skwig/ShitpostBot/refs/heads/master/test/sample-data/family_guy_bill_gates.webp"
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.test("Response has tracked=true", function () {
        client.assert(response.body.tracked === true, "tracked should be true");
    });

    client.global.set("secondImageMessageId", response.body.messageId);
%}

### 1c. Query actions - expect 0 reactions (not a repost)
GET {{host}}/test/actions/{{secondImageMessageId}}?expectedCount=0&timeout=5000

> {%
    client.test("GET returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId matching request", function () {
        const requestedId = parseInt(client.global.get("secondImageMessageId"));
        client.assert(response.body.messageId === requestedId, "messageId should match requested ID");
    });

    client.test("Response has exactly 0 actions", function () {
        client.assert(response.body.actions.length === 0, "Should have exactly 0 actions (no repost)");
    });

    client.test("Actions array is empty", function () {
        client.assert(Array.isArray(response.body.actions), "actions should be an array");
        client.assert(response.body.actions.length === 0, "actions array should be empty");
    });

    client.test("Response has waitedMs field", function () {
        client.assert(response.body.waitedMs !== undefined, "waitedMs should be present");
        client.assert(typeof response.body.waitedMs === "number", "waitedMs should be a number");
    });
%}

### 1d. Ask where is the repost
POST {{host}}/test/bot-command
Content-Type: application/json

{
  "command": "repost where",
  "referencedMessageId": {{secondImageMessageId}}
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.global.set("commandMessageId", response.body.messageId);
%}

### 1e. Query actions - expect "Not a repost"
GET {{host}}/test/actions/{{commandMessageId}}?expectedCount=1&timeout=5000

> {%
    client.test("GET returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId matching request", function () {
        const requestedId = parseInt(client.global.get("commandMessageId"));
        client.assert(response.body.messageId === requestedId, "messageId should match requested ID");
    });

    client.test("Response has exactly 1 action", function () {
        client.assert(response.body.actions.length === 1, "Should have exactly 1 action");
    });

    client.test("Action is a message type", function () {
        const action = response.body.actions[0];
        client.assert(action.type === "message", "Action type should be 'message'");
    });

    client.test("Message content contains 'Not a repost'", function () {
        const action = response.body.actions[0];
        const data = JSON.parse(action.data);
        client.assert(data.content.includes("Not a repost"), "Message should contain 'Not a repost'");
    });

    client.test("Response has waitedMs field", function () {
        client.assert(response.body.waitedMs !== undefined, "waitedMs should be present");
        client.assert(typeof response.body.waitedMs === "number", "waitedMs should be a number");
    });
%}
