# ============================================
# SCENARIO 2: Reposting downscaled
# ============================================
# This scenario tests that the same image at different scales
# is correctly detected as a repost with 2 emoji reactions.

### 2a. Post original obisidanslop
< {%
    client.global.clearAll()
%}
POST {{host}}/test/message
Content-Type: application/json

{
  "attachments": [
    {
      "url": "file:///test-data/obsidianslop.webp",
      "width": 512,
      "height": 512
    }
  ]
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.test("Response has tracked=true", function () {
        client.assert(response.body.tracked === true, "tracked should be true");
    });

    client.global.set("webpOriginalMessageId", response.body.messageId);
%}

### 2b. Repost obsidianslop (same image, 50% scale)
POST {{host}}/test/message
Content-Type: application/json

{
  "attachments": [
    {
      "url": "file:///test-data/obsidianslop_50.webp",
      "width": 512,
      "height": 512
    }
  ]
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.test("Response has tracked=true", function () {
        client.assert(response.body.tracked === true, "tracked should be true");
    });

    client.global.set("webpRepostMessageId", response.body.messageId);
%}

### 2c. Query actions - expect 2 reactions (repost)
GET {{host}}/test/actions/{{webpRepostMessageId}}?expectedCount=2&timeout=5000

> {%
    client.test("GET returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId matching request", function () {
        const requestedId = parseInt(client.global.get("webpRepostMessageId"));
        client.assert(response.body.messageId === requestedId, "messageId should match requested ID");
    });

    client.test("Response has exactly 2 actions", function () {
        client.assert(response.body.actions.length === 2, "Should have exactly 2 actions");
    });

    client.test("Both actions are reactions", function () {
        const actions = response.body.actions;
        client.assert(actions[0].type === "reaction", "First action should be reaction");
        client.assert(actions[1].type === "reaction", "Second action should be reaction");
    });

    client.test("First reaction is police_car emoji", function () {
        const firstAction = response.body.actions[0];
        const data = JSON.parse(firstAction.data);
        client.assert(data.emoji === ":police_car:", "First emoji should be :police_car:");
    });

    client.test("Second reaction is rotating_light emoji", function () {
        const secondAction = response.body.actions[1];
        const data = JSON.parse(secondAction.data);
        client.assert(data.emoji === ":rotating_light:", "Second emoji should be :rotating_light:");
    });

    client.test("Response has waitedMs field", function () {
        client.assert(response.body.waitedMs !== undefined, "waitedMs should be present");
        client.assert(typeof response.body.waitedMs === "number", "waitedMs should be a number");
    });
%}