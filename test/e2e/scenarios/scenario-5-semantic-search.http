# ============================================
# SCENARIO 5: Semantic Search
# ============================================
# This scenario tests semantic search functionality using text queries
# to find similar images.

### 5a. Search for "cat" (from scenario 1)
POST {{host}}/test/message
Content-Type: application/json

{
  "content": "<@0> search cat",
  "currentMemberId": 0
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId", function () {
        client.assert(response.body.messageId !== undefined, "messageId should be present");
        client.assert(typeof response.body.messageId === "number", "messageId should be a number");
    });

    client.global.set("searchCommandMessageId", response.body.messageId);
%}

### 5b. Query actions - expect search results
GET {{host}}/test/actions/{{searchCommandMessageId}}?expectedCount=1&timeout=5000

> {%
    client.test("GET returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has messageId matching request", function () {
        const requestedId = parseInt(client.global.get("searchCommandMessageId"));
        client.assert(response.body.messageId === requestedId, "messageId should match requested ID");
    });

    client.test("Response has exactly 1 action", function () {
        client.assert(response.body.actions.length === 1, "Should have exactly 1 action");
    });

    client.test("Action is message with embeds", function () {
        const action = response.body.actions[0];
        client.assert(action.type === "message", "Action type should be 'message'");
        const data = JSON.parse(action.data);
        client.assert(data.embeds !== undefined, "Should have embeds");
        client.assert(Array.isArray(data.embeds), "Embeds should be an array");
        client.assert(data.embeds.length > 0, "Should have at least one embed");
    });

    client.test("Results contain similarity scores in embed titles", function () {
        const action = response.body.actions[0];
        const data = JSON.parse(action.data);
        const firstEmbed = data.embeds[0];
        client.assert(firstEmbed.title.includes("Result #1"), "First embed should be Result #1");
        client.assert(firstEmbed.title.includes("Match:"), "Title should contain Match:");
        client.assert(firstEmbed.title.match(/\d+\.\d{8}/), "Should contain similarity score");
    });

    client.test("Embeds have thumbnails", function () {
        const action = response.body.actions[0];
        const data = JSON.parse(action.data);
        const firstEmbed = data.embeds[0];
        client.assert(firstEmbed.thumbnail !== undefined, "Embed should have thumbnail");
        client.assert(firstEmbed.thumbnail !== null, "Thumbnail should not be null");
    });

    client.test("Response has waitedMs field", function () {
        client.assert(response.body.waitedMs !== undefined, "waitedMs should be present");
        client.assert(typeof response.body.waitedMs === "number", "waitedMs should be a number");
    });
%}

### 5c. Search with unrelated query (low confidence test)
POST {{host}}/test/message
Content-Type: application/json

{
  "content": "<@0> search completely unrelated xyz123 gibberish",
  "currentMemberId": 0
}

> {%
    client.test("POST returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.global.set("lowConfidenceSearchCommandMessageId", response.body.messageId);
%}

### 5d. Query actions - expect low confidence results
GET {{host}}/test/actions/{{lowConfidenceSearchCommandMessageId}}?expectedCount=1&timeout=5000

> {%
    client.test("GET returns 200", function () {
        client.assert(response.status === 200, "Expected status 200");
    });

    client.test("Response has exactly 1 action", function () {
        client.assert(response.body.actions.length === 1, "Should have exactly 1 action");
    });

    client.test("Results returned as embeds regardless of confidence", function () {
        const action = response.body.actions[0];
        const data = JSON.parse(action.data);
        // Verify we got results back as embeds (no separate low confidence indicator)
        client.assert(data.embeds !== undefined, "Should have embeds");
        client.assert(Array.isArray(data.embeds), "Embeds should be an array");
        client.assert(data.embeds.length > 0, "Should have at least one embed");
    });
%}
