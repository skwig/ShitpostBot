# Model Migration System Implementation Plan

**Date:** 2025-12-16  
**Goal:** Implement a system to re-evaluate all existing image embeddings when the ML model changes, including model version tracking and a manually-triggered Kubernetes CronJob for migration.

**Context:** The ML service model has been switched to a new version that produces incompatible embeddings. All existing embeddings need to be regenerated with the new model, and future model changes should be trackable.

**Architecture:** 
- Add model name tracking to `ImageFeatures` domain model
- Extend `ImagePostTracked` event with `IsReEvaluation` flag to suppress reactions during migration
- Create `ShitpostBot.PostReevaluator` worker that queries outdated embeddings and republishes events
- Deploy as suspended Kubernetes CronJob for manual triggering
- Use EF Core migration to add `ModelName` column with "legacy" default for existing data

**Tech Stack:**
- **C#**: .NET 10.0, Entity Framework Core, MassTransit, Refit
- **Python**: FastAPI ML service endpoint
- **Database**: PostgreSQL with pgvector
- **Infrastructure**: Kubernetes CronJob, Helm charts, Docker

---

## Task 1: Add Model Name Endpoint to ML Service

**Files:**
- Modify: `src/ShitpostBot.MlService/src/app.py`

**Changes:**

1. Add model name constant at module level (after `app = FastAPI()`):
```python
MODEL_NAME = "clip-ViT-B-32"
```

2. Add new endpoint after `@app.get("/healthz")`:
```python
@app.get("/model/name")
def get_model_name():
    return {"model_name": MODEL_NAME}
```

**Verification:**
```bash
curl http://localhost:8080/model/name
# Expected: {"model_name":"clip-ViT-B-32"}
```

---

## Task 2: Update Domain Model with ModelName

**Files:**
- Modify: `src/ShitpostBot/src/ShitpostBot.Domain/Posts/ImageFeatures.cs`

**Changes:**

Update `ImageFeatures` value object to include `ModelName` as the first property:

```csharp
public class ImageFeatures : ComparableValueObject
{
    public string ModelName { get; private set; }      // NEW - First property
    public Vector FeatureVector { get; private set; }
    
    private ImageFeatures()
    {
        // For EF
        ModelName = null!;
        FeatureVector = null!;
    }
    
    public ImageFeatures(string modelName, Vector featureVector)
    {
        ModelName = modelName;
        FeatureVector = featureVector;
    }
    
    protected override IEnumerable<IComparable> GetComparableEqualityComponents()
    {
        yield return ModelName;
        foreach (var feature in FeatureVector.ToArray())
        {
            yield return feature;
        }
    }
}
```

**Notes:**
- `ModelName` is first property for priority in equality comparisons
- Constructor parameter order matches property order
- EF parameterless constructor updated

**Impact:** This change will require updates to all code that creates `ImageFeatures` instances.

---

## Task 3: Update Entity Framework Configuration

**Files:**
- Modify: `src/ShitpostBot/src/ShitpostBot.Infrastructure/Internal/Configurations/ImagePostConfiguration.cs`

**Changes:**

Add `ModelName` property configuration:

```csharp
public void Configure(EntityTypeBuilder<ImagePost> builder)
{
    builder.OwnsOne(imagePost => imagePost.Image, navigationBuilder =>
    {
        navigationBuilder.OwnsOne(image => image.ImageFeatures, ownedNavigationBuilder =>
        {
            ownedNavigationBuilder.Property(imageFeatures => imageFeatures.ModelName)
                .IsRequired();
            
            ownedNavigationBuilder.Property(imageFeatures => imageFeatures.FeatureVector)
                .HasColumnType("vector");
        });
    });
}
```

**Notes:**
- No explicit column name - EF will auto-generate as `Image_ImageFeatures_ModelName`
- Property is required (NOT NULL)

---

## Task 4: Create Entity Framework Migration

**Commands:**
```bash
dotnet ef migrations add AddModelNameToImageFeatures \
  --project src/ShitpostBot/src/ShitpostBot.Infrastructure \
  --startup-project src/ShitpostBot/src/ShitpostBot.Infrastructure.Migrator
```

**Manual edit required:**

After generation, edit the migration file to populate existing rows with "legacy":

```csharp
protected override void Up(MigrationBuilder migrationBuilder)
{
    // Add column (generated by EF)
    migrationBuilder.AddColumn<string>(
        name: "Image_ImageFeatures_ModelName",
        table: "Posts",
        type: "text",
        nullable: true);  // Initially nullable
    
    // MANUAL: Populate existing rows with "legacy"
    migrationBuilder.Sql(
        @"UPDATE ""Posts"" 
          SET ""Image_ImageFeatures_ModelName"" = 'legacy' 
          WHERE ""Image_ImageFeatures_FeatureVector"" IS NOT NULL");
    
    // MANUAL: Make column required
    migrationBuilder.AlterColumn<string>(
        name: "Image_ImageFeatures_ModelName",
        table: "Posts",
        type: "text",
        nullable: false);
}
```

**Verification:**
```bash
# Build migration project
dotnet build src/ShitpostBot/src/ShitpostBot.Infrastructure.Migrator

# Run migration locally
docker-compose up database -d
dotnet run --project src/ShitpostBot/src/ShitpostBot.Infrastructure.Migrator

# Verify column exists
psql -h localhost -U postgres -d shitpostbot -c "\d \"Posts\""
```

---

## Task 5: Update ImagePostTracked Event

**Files:**
- Modify: `src/ShitpostBot/src/ShitpostBot.Infrastructure/Internal/Messages/ImagePostTracked.cs`

**Changes:**

```csharp
namespace ShitpostBot.Infrastructure.Messages;

public class ImagePostTracked
{
    public long ImagePostId { get; init; }
    public bool IsReEvaluation { get; init; }  // NEW
}
```

**Purpose:** When `IsReEvaluation = true`, the handler will skip Discord reactions but still compute and store the new embedding.

---

## Task 6: Add Model Name API Method

**Files:**
- Modify: `src/ShitpostBot/src/ShitpostBot.Application/Services/IImageFeatureExtractorApi.cs`

**Changes:**

Add new Refit method and response DTO:

```csharp
public interface IImageFeatureExtractorApi
{
    // Existing methods...
    
    [Get("/model/name")]
    Task<ModelNameResponse> GetModelNameAsync();
}

public class ModelNameResponse
{
    [JsonPropertyName("model_name")]
    public string ModelName { get; set; } = null!;
}
```

---

## Task 7: Update Repost Handler

**Files:**
- Modify: `src/ShitpostBot/src/ShitpostBot.Application/Features/Repost/EvaluateRepost_ImagePostTrackedHandler.cs`

**Changes:**

1. Fetch model name from ML service
2. Update `ImageFeatures` constructor call with new parameter order
3. Add early return when `IsReEvaluation` is true

```csharp
public async Task Consume(ConsumeContext<ImagePostTracked> context)
{
    var postToBeEvaluated = await unitOfWork.ImagePostsRepository.GetById(context.Message.ImagePostId);
    if (postToBeEvaluated == null)
    {
        throw new InvalidOperationException($"ImagePost {context.Message.ImagePostId} not found");
    }

    // NEW: Fetch current model name
    var modelNameResponse = await imageFeatureExtractorApi.GetModelNameAsync();
    
    var extractImageFeaturesResponse = await imageFeatureExtractorApi.ProcessImageAsync(new ProcessImageRequest
    {
        ImageUrl = postToBeEvaluated.Image.ImageUri.ToString(),
        Embedding = true,
        Caption = false,
        Ocr = false
    });

    // UPDATED: Pass modelName as first parameter
    var imageFeatures = new ImageFeatures(
        modelNameResponse.ModelName,
        new Vector(extractImageFeaturesResponse.Embedding ?? throw new InvalidOperationException("ML service did not return embedding"))
    );
    postToBeEvaluated.SetImageFeatures(imageFeatures, dateTimeProvider.UtcNow);

    await unitOfWork.SaveChangesAsync(context.CancellationToken);

    // NEW: Skip repost detection if this is a re-evaluation
    if (context.Message.IsReEvaluation)
    {
        logger.LogDebug("Skipping repost detection for ImagePost {ImagePostId} (re-evaluation mode)", context.Message.ImagePostId);
        return;
    }

    // Existing repost detection logic (unchanged)
    var mostSimilarWhitelisted = await imagePostsReader
        .ClosestWhitelistedToImagePostWithFeatureVector(postToBeEvaluated.PostedOn, postToBeEvaluated.Image.ImageFeatures!.FeatureVector)
        .FirstOrDefaultAsync(context.CancellationToken);

    if (mostSimilarWhitelisted?.CosineSimilarity >= (double)options.Value.RepostSimilarityThreshold)
    {
        logger.LogDebug("Similarity of {Similarity:0.00000000} with {ImagePostId}, which is whitelisted", 
            mostSimilarWhitelisted?.CosineSimilarity, mostSimilarWhitelisted?.ImagePostId);
        return;
    }

    var mostSimilar = await imagePostsReader
        .ClosestToImagePostWithFeatureVector(postToBeEvaluated.PostedOn, postToBeEvaluated.Image.ImageFeatures!.FeatureVector)
        .FirstOrDefaultAsync(context.CancellationToken);

    if (mostSimilar?.CosineSimilarity >= (double)options.Value.RepostSimilarityThreshold)
    {
        var identification = new MessageIdentification(
            postToBeEvaluated.ChatGuildId,
            postToBeEvaluated.ChatChannelId,
            postToBeEvaluated.PosterId,
            postToBeEvaluated.ChatMessageId
        );

        foreach (var repostReaction in RepostReactions)
        {
            await chatClient.React(identification, repostReaction);
            await Task.Delay(TimeSpan.FromMilliseconds(500), context.CancellationToken);
        }
    }
}
```

---

## Task 8: Create PostReevaluator Project

**New project:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/`

**Files to create:**
- `ShitpostBot.PostReevaluator.csproj`
- `Program.cs`
- `PostReevaluatorWorker.cs`
- `appsettings.json`
- `appsettings.Development.json`
- `appsettings.Production.json`
- `Dockerfile`

### 8.1: Create .csproj

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/ShitpostBot.PostReevaluator.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk.Worker">

  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>dotnet-ShitpostBot.PostReevaluator-random-guid-here</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Hosting" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\ShitpostBot.Infrastructure\ShitpostBot.Infrastructure.csproj" />
    <ProjectReference Include="..\ShitpostBot.Application\ShitpostBot.Application.csproj" />
  </ItemGroup>

</Project>
```

### 8.2: Create Program.cs

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/Program.cs`

```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using ShitpostBot.Application;
using ShitpostBot.Infrastructure;

namespace ShitpostBot.PostReevaluator;

public class Program
{
    public static void Main(string[] args)
    {
        CreateHostBuilder(args).Build().Run();
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureAppConfiguration((hostingContext, config) =>
            {
                config.SetBasePath(Directory.GetCurrentDirectory());
                config.AddJsonFile("appsettings.json", optional: true, reloadOnChange: true);
                config.AddJsonFile($"appsettings.{hostingContext.HostingEnvironment.EnvironmentName}.json", 
                    optional: false, reloadOnChange: true);
                config.AddEnvironmentVariables();
            })
            .ConfigureServices((hostContext, services) =>
            {
                services.AddShitpostBotInfrastructure(hostContext.Configuration);
                services.AddShitpostBotApplication(hostContext.Configuration);
                services.AddHostedService<PostReevaluatorWorker>();
            });
}
```

### 8.3: Create PostReevaluatorWorker.cs

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/PostReevaluatorWorker.cs`

```csharp
using MassTransit;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using ShitpostBot.Application.Services;
using ShitpostBot.Domain;
using ShitpostBot.Infrastructure.Messages;

namespace ShitpostBot.PostReevaluator;

public class PostReevaluatorWorker(
    ILogger<PostReevaluatorWorker> logger,
    IServiceScopeFactory factory) : IHostedService
{
    private const int PageSize = 100;
    private const int ThrottleDelayMs = 75; // 50-100ms throttle

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        logger.LogInformation("PostReevaluatorWorker starting at: {time}", DateTimeOffset.Now);

        using var serviceScope = factory.CreateScope();
        var applicationLifetime = serviceScope.ServiceProvider.GetRequiredService<IHostApplicationLifetime>();
        var unitOfWork = serviceScope.ServiceProvider.GetRequiredService<IUnitOfWork>();
        var imageFeatureExtractorApi = serviceScope.ServiceProvider.GetRequiredService<IImageFeatureExtractorApi>();
        var bus = serviceScope.ServiceProvider.GetRequiredService<IBus>();

        try
        {
            // Fetch current model name from ML service
            var modelNameResponse = await imageFeatureExtractorApi.GetModelNameAsync();
            var currentModelName = modelNameResponse.ModelName;
            
            logger.LogInformation("Current ML model: {ModelName}", currentModelName);

            // Query all ImagePosts with embeddings that don't match current model
            var totalProcessedCount = 0;
            var pageNumber = 0;

            while (!cancellationToken.IsCancellationRequested)
            {
                var imagePosts = await unitOfWork.ImagePostsRepository
                    .Query()
                    .Where(p => p.Image.ImageFeatures != null 
                             && p.Image.ImageFeatures.ModelName != currentModelName)
                    .OrderBy(p => p.Id)
                    .Skip(pageNumber * PageSize)
                    .Take(PageSize)
                    .ToListAsync(cancellationToken);

                if (!imagePosts.Any())
                {
                    logger.LogInformation("No more outdated embeddings found. Migration complete.");
                    break;
                }

                foreach (var imagePost in imagePosts)
                {
                    logger.LogDebug("Publishing re-evaluation for ImagePost {ImagePostId} (current model: {CurrentModel})",
                        imagePost.Id, imagePost.Image.ImageFeatures?.ModelName ?? "null");

                    await bus.Publish(new ImagePostTracked
                    {
                        ImagePostId = imagePost.Id,
                        IsReEvaluation = true
                    }, cancellationToken);

                    totalProcessedCount++;

                    // Throttle to avoid overwhelming the queue (50-100ms)
                    await Task.Delay(ThrottleDelayMs, cancellationToken);
                }

                pageNumber++;
                logger.LogInformation("Processed page {PageNumber}: {BatchCount} posts queued, {TotalCount} total",
                    pageNumber, imagePosts.Count, totalProcessedCount);
            }

            logger.LogInformation("PostReevaluatorWorker completed: {ProcessedCount} posts queued for re-evaluation", totalProcessedCount);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "PostReevaluatorWorker failed");
            throw;
        }
        finally
        {
            applicationLifetime.StopApplication();
        }
    }

    public Task StopAsync(CancellationToken cancellationToken) => Task.CompletedTask;
}
```

### 8.4: Create Configuration Files

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/appsettings.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  }
}
```

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/appsettings.Development.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "ShitpostBot": "Debug",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  }
}
```

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/appsettings.Production.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "ShitpostBot": "Information",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  }
}
```

### 8.5: Create Dockerfile

**File:** `src/ShitpostBot/src/ShitpostBot.PostReevaluator/Dockerfile`

```dockerfile
FROM mcr.microsoft.com/dotnet/runtime:10.0 AS base
WORKDIR /app

FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src
COPY ["src/ShitpostBot/src/ShitpostBot.PostReevaluator/ShitpostBot.PostReevaluator.csproj", "ShitpostBot.PostReevaluator/"]
COPY ["src/ShitpostBot/src/ShitpostBot.Infrastructure/ShitpostBot.Infrastructure.csproj", "ShitpostBot.Infrastructure/"]
COPY ["src/ShitpostBot/src/ShitpostBot.Application/ShitpostBot.Application.csproj", "ShitpostBot.Application/"]
COPY ["src/ShitpostBot/src/ShitpostBot.Domain/ShitpostBot.Domain.csproj", "ShitpostBot.Domain/"]
RUN dotnet restore "ShitpostBot.PostReevaluator/ShitpostBot.PostReevaluator.csproj"
COPY src/ShitpostBot/src/ .
WORKDIR "/src/ShitpostBot.PostReevaluator"
RUN dotnet build "ShitpostBot.PostReevaluator.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "ShitpostBot.PostReevaluator.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "ShitpostBot.PostReevaluator.dll"]
```

---

## Task 9: Create Helm Chart for PostReevaluator

**New chart:** `charts/shitpostbot/charts/post-reevaluator/`

### 9.1: Create Chart.yaml

**File:** `charts/shitpostbot/charts/post-reevaluator/Chart.yaml`

```yaml
apiVersion: v2
name: post-reevaluator
description: Post re-evaluation job for migrating embeddings to new ML models
type: application
version: 0.1.0
appVersion: "1.0"
```

### 9.2: Create Helper Templates

**File:** `charts/shitpostbot/charts/post-reevaluator/templates/_helpers.tpl`

Copy from migrator chart and replace "migrator" with "post-reevaluator".

**File:** `charts/shitpostbot/charts/post-reevaluator/templates/_validate.tpl`

Copy from migrator chart.

### 9.3: Create ConfigMap Template

**File:** `charts/shitpostbot/charts/post-reevaluator/templates/configmap.yaml`

Copy from migrator chart and replace "migrator" with "post-reevaluator".

### 9.4: Create ServiceAccount Template

**File:** `charts/shitpostbot/charts/post-reevaluator/templates/serviceaccount.yaml`

Copy from migrator chart and replace "migrator" with "post-reevaluator".

### 9.5: Create CronJob Template

**File:** `charts/shitpostbot/charts/post-reevaluator/templates/cronjob.yaml`

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "post-reevaluator.fullname" . }}
  labels:
    {{- include "post-reevaluator.labels" . | nindent 4 }}
spec:
  schedule: "0 0 31 2 *"  # Feb 31st = Never (suspended by default)
  suspend: true  # Manually triggered only
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: {{ default 1 .Values.backoffLimit }}
      template:
        metadata:
          {{- with .Values.podAnnotations }}
          annotations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          labels:
            {{- include "post-reevaluator.labels" . | nindent 12 }}
            {{- with .Values.podLabels }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
        spec:
          restartPolicy: OnFailure
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          serviceAccountName: {{ include "post-reevaluator.serviceAccountName" . }}
          {{- with .Values.podSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
            - name: {{ .Chart.Name }}
              {{- with .Values.securityContext }}
              securityContext:
                {{- toYaml . | nindent 16 }}
              {{- end }}
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Values.global.imageTag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              envFrom:
                - configMapRef:
                    name: {{ include "post-reevaluator.configMapName" . }}
              {{- with .Values.resources }}
              resources:
                {{- toYaml . | nindent 16 }}
              {{- end }}
          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
```

---

## Task 10: Update Parent Helm Values

**Files:**
- Modify: `charts/shitpostbot/values.yaml`

**Changes:**

Add new section at the end:

```yaml
post-reevaluator:
  backoffLimit: 1

  image:
    repository: ghcr.io/skwig/shitpostbot/post-reevaluator
    pullPolicy: IfNotPresent
    tag: ""

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  config:
    create: true
    name: ""
    data: {}

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels: {}
  podSecurityContext: {}
  securityContext: {}
  resources: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
```

---

## Task 11: Update GitHub Actions Workflow

**Files:**
- Modify: `.github/workflows/ci.yml`

**Changes:**

Add build and push steps for post-reevaluator (add after migrator steps):

```yaml
- name: Build post-reevaluator
  run: dotnet build src/ShitpostBot/src/ShitpostBot.PostReevaluator/ShitpostBot.PostReevaluator.csproj

- name: Build and push post-reevaluator image
  uses: docker/build-push-action@v5
  with:
    context: .
    file: src/ShitpostBot/src/ShitpostBot.PostReevaluator/Dockerfile
    push: ${{ github.event_name != 'pull_request' }}
    tags: ghcr.io/skwig/shitpostbot/post-reevaluator:${{ github.sha }}
```

---

## Deployment & Usage

### Local Testing

```bash
# Build and run locally
docker-compose up database rabbitmq ml-service -d
dotnet run --project src/ShitpostBot/src/ShitpostBot.PostReevaluator
```

### Kubernetes Deployment

```bash
# Deploy with Helm
helm upgrade --install shitpostbot ./charts/shitpostbot

# Manually trigger the re-evaluation job
kubectl create job --from=cronjob/shitpostbot-post-reevaluator manual-reevaluation-$(date +%Y%m%d-%H%M%S)

# Monitor progress
kubectl logs -f job/manual-reevaluation-YYYYMMDD-HHMMSS

# Check job status
kubectl get jobs -l app=post-reevaluator -w
```

### Verification

```sql
-- Check how many posts still need re-evaluation
SELECT COUNT(*) 
FROM "Posts" 
WHERE "Image_ImageFeatures_ModelName" != 'clip-ViT-B-32'
  AND "Image_ImageFeatures_FeatureVector" IS NOT NULL;

-- Check migration progress
SELECT "Image_ImageFeatures_ModelName", COUNT(*) 
FROM "Posts" 
WHERE "Image_ImageFeatures_FeatureVector" IS NOT NULL
GROUP BY "Image_ImageFeatures_ModelName";
```

---

## Rollback Plan

If issues arise during re-evaluation:

1. **Stop the job immediately:**
   ```bash
   kubectl delete job manual-reevaluation-YYYYMMDD-HHMMSS
   ```

2. **Drain RabbitMQ queue** (if messages are causing issues):
   - Access RabbitMQ management UI
   - Purge the `ImagePostTracked` queue

3. **Investigate logs:**
   ```bash
   kubectl logs job/manual-reevaluation-YYYYMMDD-HHMMSS
   kubectl logs -l app=worker --tail=100
   ```

4. **Fix and retry:**
   - Apply code fixes
   - Rebuild and redeploy
   - Create new manual job

---

## Performance Estimates

- **Throttle rate:** 75ms per post = ~13 posts/second
- **10,000 posts:** ~13 minutes to publish all events
- **Processing time:** Depends on worker count and ML service capacity
- **Expected duration:** 30-60 minutes for 10,000 posts (with 2-3 workers)

---

## Notes

- The migration is **idempotent** - re-running on the same ImagePostId just updates the embedding again
- Worker scaling can be increased temporarily during migration for faster processing
- The CronJob is suspended by default - it will never run automatically
- Model name is stored with each embedding for future migrations
- The `IsReEvaluation` flag ensures no Discord spam during migration
